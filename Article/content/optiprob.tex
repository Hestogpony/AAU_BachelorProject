\subsection{Optimization problem}
In this section a fomal describtion of how to calculate the speed to drive on each road segment and the amount of energy to charge at each charge stations, in order to solve a path optimally in terms of time. The paths the optimization problem is intended to solve are modelled in the following way: \\
\begin{figure}[h!]
\centering
    \begin{tikzpicture}[shorten >=1pt,node distance=2cm,>=stealth',thick]
        \node[state] (1) {$u_1$};
        \node[state] (2) [right of=1] {$u_2$};
        \node[] (dots) [right of=2] {$\dots$};
        \node[state] (n) [right of=dots] {$u_n$};
        \node[state,draw=none] (d1) [right of=n] {};
        \draw [->] (1) to[right] node[auto] {$e_1$} (2);
        \draw [->] (2) to[right] node[auto] {$e_2$} (dots);
        \draw [->] (dots) to[right] node[auto] {$e_{n-1}$} (n);
        \draw [->] (n) to[right] node[auto] {$e_n$} (d1);
    \end{tikzpicture}
    \caption{Example of a path consisting of $n$ edges} \label{fig:pathexample}
\end{figure} \\

The objective of the optimization problem is to minimize the time spend driving 
and the time spend charging for the entire path. The optimization problem can be expressed as follows:

\begin{equation}
	\begin{aligned} & 
	{\text{minimize:}}
	& & \sum_{i=1}^{n} \frac{D(e_i)}{v(e_i)} + charge\_time(u_i) \\
	\end{aligned}
\end{equation}\label{eq:objfunction}

Where $D(e_i)$ is the distance of road segment $i$, $v(e_i)$ is the actual speed driven at road segment $i$ and $charge\_time(u_i)$ is the time spend charging at charge station $i$. It should be clear that the objective function of this problem is concerned with time, being that $\frac{D(e_i)}{v(e_i)}$ is the time spend driving and $charge\_time(u_i)$ is the time spend charging. Having this objective function we now know which unknown variables we need to find. The problem is as described in \cref{sub:problem_definition} the problem is constrainted by the proberties of the $EV$ driving the path.  
The constraints can be formulated as follows: \\
On all edges the speed of the electrical vehicle must be within the speed limits of the specific edge. $v(e_i)$ is the speed on edge $e_i$. $v_{min}(e_i)$ and $v_{max}(e_i)$ is the minimum and maximum speed limit. So we have that $v_{min}(e_i) \leq v(e_i) \leq v_{max}(e_i)$ for all .
 
\begin{equation}
v_{min}(e_i) \leq v(e_i) \leq v_{max}(e_i) \text{ for } i = 1..n  
\end{equation}

The battery level of the EV, $B_{cur}$, has to be between $0$ and the max battery capacity of the vehicle, $B_{max}$. The constraint is split up in two constraints which looks quite similar. The first constraint is ensuring that the EV will have enough energy to drive each edge and the second constraint is ensuring that the EV can not over charge at any charge station. $R_{CO}(v)$ is the the energy consumption rate of the EV, given the speed $v$. $EC(u_j)$ is the energy charged at charge station $u_j$ and $ES(e_j)$ is the
energy spend on edge $e_j$.  

\begin{equation}
EC(u_j) = R_{CH}(u_j) * charge\_time(u_j)
\end{equation}

\begin{equation}
ES(e_j) = D(e_j)*R_{CO}(v(e_j))
\end{equation} 

\begin{equation}
0 \leq \sum_{j=1}^{i} EC(u_j) - ES(e_j) \leq B_{max} \text{ for } i = 1..n
\end{equation}

\begin{equation}
\begin{aligned}
0 \leq \sum_{j=i}^{i+1} EC(u_j) - ES(e_j) \leq B_{max} \text{ for } i = 1..n
\end{aligned}
\end{equation}

It should also not be possible for the EV to spend a negative amount of time at a charge station:

\begin{equation}
0 \leq charge\_time(u_i) \text{ for } i = 1..n 
\end{equation}

This optimisation problem is almost a linear programming problem. However, we suffer from a non-linear constraint: $D(e_i)*R_{CO}(v(e_i))$ since the consumption rate $R_{CO}(v(e_i))$ of the EV is not linear. The function can however be estimated using linearisation. 

subject to: 
\begin{equation}
\forall_{i\in1 \dots n }:\; \sum_{j=1}^{m} Selectedlines[i,j] = 1
\end{equation}

\begin{equation}
\forall_{i\in1 \dots n, j \in 1 \dots m}: \; \;0\leq Selectedlines[i,j] \leq 1
\end{equation}

\begin{equation}
\forall_{i\in1 \dots n, j \in 1 \dots m}:\; v(e_i) \le Selectedlines[i,j] * Points1[i,j]
\end{equation}

\begin{equation}
\forall_{i\in1 \dots n, j \in 1 \dots m}:\; v(e_i) \ge Selectedlines[i,j] * Points2[i,j]
\end{equation}

\begin{equation}
\begin{split}
\forall_{k\in1 \dots n}\;:\;0 \le\sum_{i=1}^{k}chargerate[i]*charge[i]\\
-\sum_{i=1}^{k} distance[i](\sum_{j=1}^{m} LinesA[i,j]*speed[i,j]\\
+\sum_{j=1}^{m} Selectedlines[i,j]*LinesB[i,j]) \le maxbattery\;capacity
\end{split}
\end{equation}
