\subsection{Greedy Heuristic Path}\label{sec:greedy}
Realising that even approximately solving a path optimal is very expensive, we will now interest ourselves with the notion of a greedy and heuristic approach. The problem then becomes, which speed must we use for the current edge, in the interval of $v_{min}$ and $v_{max}$. As argued previously, the optimal speed to drive can only be found by iterating over all possibilities which is a NP-Hard combinatorial optimization problem. Therefore we introduce a heuristic, which promotes optimal local choices. 

We will now analyse how to heuristically find an optimal speed given a path $P = \langle u_1,u_2,\dots,u_k \rangle$. When choosing what speed to drive at an edge, there are two probable cases:
\begin{enumerate}
	\item It is fastest to drive
	\item It is fastest to charge, and then drive
\end{enumerate}

The intuition is then to find which speed we want to drive and whether or not we should charge before driving. However, it might not be possible to drive at all, given the limited battery of the EV. The optimal speed when passing the edge $(u_i, u_{i+1})$ without charging, can be found by solving this equation for $v$:
\[B_{cur} - D(u_i, u_{i+1}) * R_{CO}(v) = 0\] 
We call this speed $v_{opt}$. If $v_{opt}$ is lower than $v_{min}(e)$, the minimum speed of the edge, there is not enough energy in the battery to drive from $u_i$ to $u_{i+1}$ and thus the time is set to $-\infty$, indicating that just driving is not an option. If it is possible to drive the edge using only energy from the battery, the time it will take to pass the edge can be calculated as:
 \[T = \frac{D((u_i, u_{i+1}))}{v_{opt}} \] 
The time spent passing an edge $(u_i, u_{i+1})$ while charging first, is given by the following equation:

\begin{equation*}
\begin{aligned}
 & T(v,(u_i, u_{i+1})) = \frac{D((u_i, u_{i+1}))}{v} + \frac{R_{CO}(v) * D((u_i, u_{i+1})) - B_{cur}}{charge_{rate}(u_{i+1})}
\end{aligned}
\end{equation*}\label{eq:drivingAndCharging}

Where $v$ is the speed of the vehicle, $D(u_i, u_{i+1})$ is the distance between vertices $u_i$ and $u_{i+1}$, $R_{CO}(v)$ is the consumption rate of the EV, $B_{cur}$ is the current battery of the vehicle. Since we only charge exactly enough to pass an edge, there might be charging stations previous to $u_i$ which we could have charged more at, without exceeding the battery capacity. Therefore we want go back in history and charge at the best previous charge stations, until we have enough energy to pass $(u_i, u_{i+1})$. This is done by $charge_{rate}(u_i)$ which gives the charge rate of the best charge previous to $u_{i+1}$. The charging stations that can be used, is of course only those who is within the EV's battery range.

The above equation yields a function of the form: $av^2 + bv + c$, due to the fact that $R_{CO}(v)$ is a quadratic function. $a$, $b$ and $c$ are some constants which are given by the instance of the vehicle. Represented in a Cartesian coordinate system, $T(v,(u_i, u_{i+1})))$ is a parabola, as can be seen in Figure \ref{fig:graph}, note that the graph is only defined for positive speeds larger than $0$ and can only be calculated if $charge_{rate}(u_{i+1})$ is larger than $0$. On the x-axis is the speed of the vehicle and on the y-axis is the time spent. The turning point of the graph represents the optimal speed to drive for the given edge, denoted as $v_{opt}(e)$. The point is easily calculated by finding a tangent line with a slope of $0$. If $v_{opt}(e)$ is smaller than $v_{min}(e)$, then $v_{min}(e)$ defines the optimal speed for the edge. Similarly if $v_{opt}(e)$ is larger than $v_{max}(e)$, $v_{max}(e)$ defines the optimal speed for the edge. If $v_{opt}(e) == v_{min}(e)$ there might be a possibility that driving and charging is not an option. 

\begin{figure}[!htb]
\label{fig:graph}
\begin{tikzpicture}
\begin{axis}[xlabel=velocity, ylabel=time,legend style={legend pos=north west}]
\addplot[draw=red,domain=0:200]{(5/x)+(((0.0286*x^2 + 0.4096*x + 107.57)*5)/5000)};
\addlegendentry{$\frac{5}{x}+\frac{(0.029*x^2 + 0.41*x + 107.57)*5}{5000}$}

\addplot[draw=black,domain=25:75]{0.295};
% \addplot[mark=*, domain=25:75] coordinates {(37,295)};
\end{axis}
\end{tikzpicture}% 
\caption{In this instance of $T(v,(u_i, u_{i+1}))$, going from $u_i$ to $u_{i+1}$, we have a distance of $5 \si{\km}$ and a charge speed of $5 \si{\kW}$ on $u_i$. The optimal speed in this case is $42.12\si{\km\per\hour}$, and the total time is roughly 17 minutes to pass through the edge when driving and charging}
\end{figure}
Having the two ways of deciding the time it takes to pass an edge, we can formulate an algorithm which decides how to drive each local road segment:
\begin{algorithmic}[1]
\Function{travel\_time}{$RN, edge, EV$}
	\State $case1\_speed = solve\:case\:1$
	\If{$ current\:battery - energy\:needed < 0 $}
		\State $case1\_time = \infty$
	\Else
		\State $case1\_time = distance\:of\:edge / case1\_speed$
		\State $case1\_energy = energy\:needed$
	\EndIf
	\While{$energy\:needed > battery \And$ 
		\State $a\:CS\: is \: in\: range$}
		\State $Select\: the\: best\: CS\: in\: range$
		\State $case2\_speed = solve\: case\: 2$		
		\If{$energy\:available < energy\:needed$}
			\State$charge\:available\:energy$
		\Else{}
			\State{$charge\:needed\:energy$}
		\EndIf
		\State $battery = battery + charged\: energy$
		\State $case2\_time = case2\_time + charge\: time$
		\If{$CS\: could\: not\: charge\: enough\: for\: the\: edge$}
			\State $remove\: best\: CS$
		\EndIf	
	\EndWhile
	\If{$CS\: can\: charge\: needed\: energy$}
		\State $case2\_time = charge\: time + edge\: distance \times case2\_speed$
	\EndIf
	\If{$case1\_time\:is\:best$}
		\State \Return $case1\_time,\: CS\: in\: range,\: energy\_used$
	\ElsIf{$case2\_time\:is\:best$}
		\State \Return $case2\_time,\: CS\: in\: range,\: energy\_used$
	\Else{$\:there\: is\: not\: enough\: battery$}
		\State \Return $\infty,\:None,\:\infty$
	\EndIf
\EndFunction
\end{algorithmic}\label{alg:fastest_path}

%\begin{algorithmic}[1]
%\Function{travel\_time}{$RN, u, v, EV$}
%	\State $e = (u, v)$
%	\State $v_{opt1} = solve1\langle v, EV.B_{cur}-RN.D(e)*EV.R_{CO}(v) = 0\rangle$
%	\If{$ u.B_{cur} - RN.D(e)*EV.R_{CO}(v_{opt1}) < 0 $}
%		\State $time_1 = \infty$
%	\Else
%		\State $time_1 = RN.D(e) / v_{opt1}$
%		\State $energy\_used_{1} = RN.D(e)*EV.R_{CO}(v_{opt1})$
%	\EndIf
%		\State $CS = getCS(u, v)$ 
%		\State $energy\_needed_{2} = \infty$
%		\State $energy = u.B_{cur}$
%		\State $time\_added = 0$
%		\State $time_2 = \infty$
%	\While{$energy\_needed_{2} > energy  \And  len(CS) \neq 0$}
%		\State $best_{CS} = extractmax(CS)$
%		\State $B_{possible} = best_{CS}.B_{possible}$
%		\State $charge\_rate = RN.R_{CH}(best_{CS})$
%		\State $v_{opt2} = solve2 \langle v, B_{possible},  RN.D(e)/v + $
%			\State $(RN.D(e)*EV.R_{CO}(v)-energy)/charge\_rate) \rangle$
%		\State $energy\_needed_{2} = RN.D(e)*EV.R_{CO}(v_{opt2})$
%		\State $energy = energy + B_{possible}$
%		\If{$v_{opt2} == -\infty$}
%			\State $time\_added = time\_added + B_{possible}/charge\_rate$
%			\State $CS.remove(0)$
%			\State $updateCS(CS)$
%		\EndIf	
%	\EndWhile
%	\If{$v_{opt2} \neq \infty$}
%		\State $time_2 = RN.D(e)*EV.R_{CO}(v_{opt2}) + $
%		\State $energy\_needed_{2}/charge\_rate + time\_added$
%		\State $energy\_used_2 = RN.D(e)*EV.R_{CO}(v_{opt2})$
%	\EndIf
%	\If{$time_1 <= time_2$}
%		\State \Return $time_1, CS, energy\_used_1$
%	\ElsIf{$time_1 > time_2$}
%		\State \Return $time_2, CS, energy\_used_2$
%	\Else
%		\State \Return $\infty, NIL, \infty$
%	\EndIf
%\EndFunction
%\end{algorithmic}
The $travel\_time$ function takes as input a road network $RN$, the two vertices which makes up the edge to be driven and the EV which is to drive the path. The function uses a few helping functions, the two solve functions $solve1$ and $solve2$ are solvers for each of the specified cases and returns the optimal speed of the EV or $\infty$ if no optimal speed is found. The function $CS = getCS(u, v)$ returns a list of charge stations. If $v$ is a charge stations with a higher charge rate than any charge station previous to $v$ then $v$ is returned otherwise $v$ is append to the list of charging stations previous to $v$, this ensure that the charge station with the best charge rate is alway the 1st in the list of previous charge stations. The last function $updateCS(CS)$ finds a new best charge station and deletes all charge stations prior to it, this is need because the best charge station have been removed by $CS.remove(0)$. Having a way to solve a single edge the time of the path can be decided by looping through all edges form $e_1$ to $e_n$  


