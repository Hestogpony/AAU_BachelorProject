\subsection{Greedy Heuristics Algorithm}
After having realised that even solving only a path optimal is very expensive, we will now interest ourselves with the notion of an approximation approach. The problem then becomes, which speed must we use for edges in a path, in the interval of $v_{min}$ and $v_{max}$. As argued previously, the optimal speed to drive can only be found by iterating over all possibilities which is a combinatorial optimization problem, and it is NP-Hard. Thus we must introduce a heuristic, which promotes local optimal choices. If there are not any charging stations on the path, it might not be drivable, we will deal with this problem later.

We will now analyse how to find this speed. Given a path $P = \langle u_1,u_2,\dots,u_k \rangle$. In measuring the fastest way to pass an edge on the path, there are two probable cases:
\begin{enumerate}
	\item It is fastest to drive
	\item It is fastest to charge, and then drive
\end{enumerate}

The intuition is then to figure out the time we will spend for both of these cases and picking the fastest option. However, it might not be possible to only drive, given the limited battery of the EV. The time spent passing the edge $(u_i, u_j)$ without charging, can be found by solving this equation for $v$:

\[B_{cur} - D(u_i, u_j) * R_{CO}(v) = 0\] 

We call this speed $v_{opt}$. If $v_{opt}(e)$ is lower than $v_{min}(e)$, the minimum speed of the edge, there is not enough energy in the battery to drive from $u_i$ to $u_j$. 

The time spent passing an edge $(u_i, u_j)$ while charging first, is given by the following equation:
\begin{equation*}
\begin{aligned}
 & T(v,(u_i, u_j)) = \frac{D((u_i, u_j))}{v} + \frac{R_{CO}(v) * D((u_i, u_j)) - B_{cur}}{charge_{rate}(u_i)}
\end{aligned}
\end{equation*}\label{eq:drivingAndCharging}


Where $v$ is the speed of the vehicle, $D(u_i, u_j)$ is the distance between vertices $u_i$ and $u_j$, $R_{CO}(v)$ is the consumption rate, $B_{cur}$ is the current battery capacity of the vehicle. Since we only charge exactly enough to pass an edge, there might be charging stations previous to $u_i$ which we could have charged more at without exceeding the battery capacity. Thus we would go back in history and charge at the best previous charge stations, recursively, until we have enough energy to pass $(u_i, u_j)$.

The above equation yields a function of the form: $av^2 + bv + c$, due to the fact that $R_{CO}(v)$ is a quadratic function. $a$, $b$ and $c$ are some constants which are given by the instance of the vehicle. Represented in a Cartesian coordinate system, $T(v,(u_i, u_j)))$ is a parabola, as can be seen in Figure \ref{fig:graph}. On the x-axis is the speed of the vehicle and on the y-axis is the time spent. The turning point of the graph represents the optimal speed to drive at for the given edge, denoted as $v_{opt}(e)$. The point is easily calculated by finding a tangent line with a slope of $0$. If $v_{opt}(e)$ is smaller than $v_{min}(e)$, then $v_{min}(e)$ defines the optimal speed for the edge. Similarly if $v_{opt}(e)$ is larger than $v_{max}(e)$, $v_{max}(e)$ defines the optimal speed for the edge.


\begin{figure}[!htb]
\label{fig:graph}
\begin{tikzpicture}
\begin{axis}[xlabel=velocity, ylabel=time,legend style={legend pos=north west}]
\addplot[draw=red,domain=0:200]{(5/x)+(((0.0286*x^2 + 0.4096*x + 107.57)*5)/5000)};
\addlegendentry{$\frac{5}{x}+\frac{(0.029*x^2 + 0.41*x + 107.57)*5}{5000}$}

\addplot[draw=black,domain=25:75]{0.295};
% \addplot[mark=*, domain=25:75] coordinates {(37,295)};
\end{axis}
\end{tikzpicture}% 
\caption{In this instance of $T(v,(u_1, u_2))$, going from $u_1$ to $u_2$, we have a distance of $5 \si{\km}$ and a charge speed of $5 \si{\kW}$ on $u_1$. The optimal speed in this case is $42.12\si{\miles\per\hour}$, which takes roughly 7 minutes to drive}
\end{figure}



\begin{algorithmic}
\Function{GreedyHeuristic}{$RN,s,t,EV$}
	\ForAll{$v \in RN.V$} 
		\State $v.time = \infty$
		\State $v.predecessor = NIL$
		\State $v.preCS = NIL$
		\State $v.B_{cur} = 0$
	\EndFor
	\State $s.time = 0$
	\State $s.B_{cur} = EV.B_{cur}$

	\State $Q = PriorityQueue$
	\State $insert(Q, (s.time, s))$	
	\While{$Q \neq \emptyset$} 
		\State $u = extractmin(Q)$
		\ForAll{$v \in RN.adj(u)$} 
			\State $time,preCS,B_{cur},energy = travel\_time(RN, u, v, EV)$
			\If{$v.time > u.time + time$} 
				\State $v.time = u.time + time$
				\State $v.predecessor = u$
				\State $v.B_{cur} = B_{cur}$
				\State $v.preCS = preCS$
				\State $insert(Q, (v.time, v))$	
			\EndIf
			\If{ $preCS \neq NIL$}
				\State $a$
			\EndIf
		\EndFor
	\EndWhile
	\State \Return $t.time, t.path$
\EndFunction
\end{algorithmic}\label{alg:fastest_path}

\begin{algorithmic}
\Function{travel\_time}{$RN, u, v, EV$}
	\State $e = (u, v)$
	\State $v_{opt}1 = solve\langle v, 0 = B_{cur}-RN.D(e)*EV.R_{CO}(v)\rangle$
	\If{$ u.B_{cur} - RN.D(e)*EV.R_{CO} < 0 $}
		\State $time1 = \infty$
	\Else
		\State $time1 = RN.D(e) / v_{opt}$
		\State $energy_needed1 = RN.D(e)*EV.R_{CO}(v_{opt})$
		\State $B_{cur}1 = u.B_{cur} - energy_needed1$
	\EndIf
		\State $CS = getCS(u)$ 
		\State $energy_needed1 = \infty$
		\State $energy = EV.B_{cap} - best_{CS}.B_{cur}$
		\State $time2 = 0$
	\While{$energy_needed1 > extra_energy and length(CS) \neq 0$}
		\State $best_{CS} = extractmin(CS)$
		\State $v_{opt} = solve \langle v, RN.D(e)/v + (energy-RN.D(e)*EV.R_{CO}(v)) \rangle$
		\State $time2 = RN.D(e)/v_{opt} + (EV.R_{CO}(v_{opt})*RN.D(e) - energy)/RN.R_{CH}(best_{CS}))$
		\

	\EndWhile


	\State \Return $t.time, t.path$
\EndFunction
\end{algorithmic}\label{alg:fastest_path}








